<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMSLEEP ç»Ÿè®¡æ•°æ®</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .config-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .config-section h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .unit {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .github-stats {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }
        
        .github-stats h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .device-list {
            margin-top: 30px;
        }
        
        .device-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .device-item h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .device-item .info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            color: #666;
            font-size: 0.9em;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 500;
            color: #555;
            margin-bottom: 3px;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs-container {
            margin-top: 20px;
        }
        
        .tabs-header {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
            position: relative;
            top: 2px;
        }
        
        .tab-button:hover {
            color: #667eea;
            background: #f5f5f5;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .device-count-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            margin-left: 6px;
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .pagination button {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            color: #333;
            font-size: 14px;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f5f5f5;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination-info {
            color: #666;
            font-size: 14px;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .device-card {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .device-card:hover {
            border-color: #667eea;
            background: #f0f0f0;
        }
        
        .device-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .device-card h5 {
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .device-card .quick-stats {
            font-size: 0.85em;
            color: #666;
        }
        
        .device-detail-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .stat-card .value {
                font-size: 2em;
            }
            
            .device-item .info {
                grid-template-columns: 1fr;
            }
            
            .tabs-header {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š XMSLEEP ç»Ÿè®¡æ•°æ®</h1>
        <p class="subtitle">åº”ç”¨ä½¿ç”¨æƒ…å†µå’Œä¸‹è½½ç»Ÿè®¡</p>
        
        <div class="config-section">
            <h2>é…ç½®</h2>
            <div class="input-group">
                <label for="githubToken">GitHub Personal Access Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxx">
                <small style="color: #666; display: block; margin-top: 5px;">
                    éœ€è¦ gist æƒé™ã€‚åˆ›å»ºToken: Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)
                </small>
            </div>
            <div class="input-group">
                <label for="gistId">Gist ID (å¯é€‰ï¼Œå¦‚æœå·²çŸ¥):</label>
                <input type="text" id="gistId" placeholder="ç•™ç©ºå°†è‡ªåŠ¨æŸ¥æ‰¾">
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="loadButton" onclick="loadStats()">åŠ è½½ç»Ÿè®¡æ•°æ®</button>
                <button id="clearButton" onclick="clearTestData()" style="background: #dc3545;">æ¸…ç†æµ‹è¯•æ•°æ®</button>
            </div>
            <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; color: #856404; font-size: 0.9em;">
                <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>å¦‚æœç½‘é¡µæ˜¾ç¤ºçš„æ•°æ®æ˜¯å‡çš„ï¼ˆå¦‚2024å¹´çš„æ•°æ®ã€999å°è®¾å¤‡ç­‰ï¼‰ï¼Œè¯·ç‚¹å‡»"æ¸…ç†æµ‹è¯•æ•°æ®"æŒ‰é’®æ¸…ç†Gistä¸­çš„æµ‹è¯•æ•°æ®ï¼Œç„¶åç¡®ä¿åº”ç”¨å·²é…ç½®GitHub Tokenå¹¶ä¸Šä¼ çœŸå®æ•°æ®ã€‚
            </div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="stats" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="flex: 1; min-width: 200px;">
                    <input type="text" id="searchInput" placeholder="æœç´¢è®¾å¤‡..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="sortSelect" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="launchCount-desc">å¯åŠ¨æ¬¡æ•° â†“</option>
                        <option value="launchCount-asc">å¯åŠ¨æ¬¡æ•° â†‘</option>
                        <option value="totalSessionTime-desc">ä½¿ç”¨æ—¶é•¿ â†“</option>
                        <option value="totalSessionTime-asc">ä½¿ç”¨æ—¶é•¿ â†‘</option>
                        <option value="uniqueDays-desc">æ´»è·ƒå¤©æ•° â†“</option>
                        <option value="uniqueDays-asc">æ´»è·ƒå¤©æ•° â†‘</option>
                        <option value="lastLaunch-desc">æœ€åä½¿ç”¨ â†“</option>
                        <option value="lastLaunch-asc">æœ€åä½¿ç”¨ â†‘</option>
                    </select>
                    <button onclick="exportData('csv')" style="background: #28a745;">å¯¼å‡º CSV</button>
                    <button onclick="exportData('json')" style="background: #17a2b8;">å¯¼å‡º JSON</button>
                    <button onclick="loadStats()" style="background: #ffc107; color: #333;">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>
            <div id="updateTime" style="color: #666; font-size: 0.9em; margin-bottom: 20px;"></div>
            
            <div class="stats-grid" id="statsGrid"></div>
            
            <div class="current-device-stats" id="currentDeviceStats" style="display: none; margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee;">
                <h2 style="color: #333; margin-bottom: 20px;">å½“å‰è®¾å¤‡ç»Ÿè®¡</h2>
                <div style="margin-bottom: 15px; padding: 15px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="margin-bottom: 10px;">
                        <label for="deviceIdInput" style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">è¾“å…¥è®¾å¤‡ ID æŸ¥çœ‹æ‚¨çš„ä½¿ç”¨ç»Ÿè®¡ï¼š</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="deviceIdInput" placeholder="è¾“å…¥è®¾å¤‡ IDï¼ˆå¯åœ¨åº”ç”¨è®¾ç½®ä¸­æŸ¥çœ‹ï¼‰" style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="loadCurrentDeviceStats()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">æŸ¥çœ‹ç»Ÿè®¡</button>
                        </div>
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ğŸ’¡ æç¤ºï¼šè®¾å¤‡ ID å¯ä»¥åœ¨åº”ç”¨çš„"å…³äº"é¡µé¢æˆ–è®¾ç½®ä¸­æ‰¾åˆ°ï¼Œæˆ–è€…ä»ä¸Šé¢çš„è®¾å¤‡åˆ—è¡¨ä¸­å¤åˆ¶ã€‚
                    </small>
                </div>
                <div id="currentDeviceStatsContent" style="display: none;">
                    <div class="stats-grid" id="currentDeviceStatsGrid"></div>
                </div>
            </div>
            
            <div class="github-stats">
                <h2>GitHub Releases ä¸‹è½½é‡ 
                    <span style="font-size: 0.6em; font-weight: normal; color: #666;">(ç‹¬ç«‹æ•°æ®æºï¼Œä»GitHub APIè·å–)</span>
                </h2>
                <div id="githubStats"></div>
            </div>
            
            <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee;">
                <h2 style="color: #333; margin-bottom: 20px;">æ•°æ®å¯è§†åŒ–</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">è®¾å¤‡ä½¿ç”¨æ—¶é•¿å¯¹æ¯”</h3>
                        <canvas id="durationChart"></canvas>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #333; margin-bottom: 15px; font-size: 1.1em;">è®¾å¤‡å¯åŠ¨æ¬¡æ•°å¯¹æ¯”</h3>
                        <canvas id="launchChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="device-list">
                <h2 style="color: #333; margin-bottom: 20px;">è®¾å¤‡ä½¿ç”¨ç»Ÿè®¡ <span id="deviceCount" style="color: #666; font-size: 0.8em; font-weight: normal;"></span></h2>
                <div id="deviceList"></div>
            </div>
        </div>
    </div>
    
    <script>
        const GITHUB_API_BASE = 'https://api.github.com';
        const REPO_OWNER = 'Tosencen';
        const REPO_NAME = 'XMSLEEP';
        
        let currentStats = null;
        let currentGithubStats = null;
        let allDevices = [];
        let filteredDevices = [];
        let durationChart = null;
        let launchChart = null;
        let currentDeviceId = null;
        
            // é¡µé¢åŠ è½½æ—¶ä»localStorageè¯»å–ä¿å­˜çš„token
        window.addEventListener('DOMContentLoaded', function() {
            const savedToken = localStorage.getItem('github_token');
            const savedGistId = localStorage.getItem('gist_id');
            const savedDeviceId = localStorage.getItem('device_id');
            
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
            }
            if (savedGistId) {
                document.getElementById('gistId').value = savedGistId;
            }
            if (savedDeviceId) {
                document.getElementById('deviceIdInput').value = savedDeviceId;
                currentDeviceId = savedDeviceId;
            }
            
            // æœç´¢å’Œæ’åºäº‹ä»¶ç›‘å¬
            document.getElementById('searchInput')?.addEventListener('input', filterAndSortDevices);
            document.getElementById('sortSelect')?.addEventListener('change', filterAndSortDevices);
            
            // ç¡®ä¿æŒ‰é’®å¯ä»¥ç‚¹å‡»
            const loadButton = document.getElementById('loadButton');
            if (loadButton) {
                loadButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘');
                    loadStats();
                });
            }
        });
        
        async function loadStats() {
            console.log('loadStats called');
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            
            console.log('Token:', token ? 'å·²è¾“å…¥' : 'æœªè¾“å…¥');
            console.log('Gist ID:', gistId || 'æœªè¾“å…¥');
            
            // ä¿å­˜tokenå’ŒgistIdåˆ°localStorage
            if (token) {
                localStorage.setItem('github_token', token);
            }
            if (gistId) {
                localStorage.setItem('gist_id', gistId);
            }
            
            if (!token) {
                showError('è¯·è¾“å…¥ GitHub Token');
                return;
            }
            
            showLoading();
            hideError();
            hideStats();
            
            try {
                // 1. è·å–æˆ–æŸ¥æ‰¾ Gist
                let actualGistId = gistId;
                if (!actualGistId) {
                    actualGistId = await findGist(token);
                }
                
                if (!actualGistId) {
                    showError('æœªæ‰¾åˆ°ç»Ÿè®¡æ•°æ® Gistã€‚è¯·ç¡®ä¿åº”ç”¨å·²è‡³å°‘ä¸Šä¼ ä¸€æ¬¡æ•°æ®ã€‚');
                    return;
                }
                
                // 2. è¯»å– Gist æ•°æ®
                const stats = await fetchGistData(token, actualGistId);
                console.log('ä»Gistè¯»å–çš„åŸå§‹æ•°æ®:', stats);
                console.log('æ•°æ®ç±»å‹:', Array.isArray(stats) ? 'æ•°ç»„' : 'å¯¹è±¡', 'æ•°æ®æ¡æ•°:', Array.isArray(stats) ? stats.length : 1);
                
                // éªŒè¯æ•°æ®æ ¼å¼
                if (stats) {
                    if (Array.isArray(stats)) {
                        console.log('æ•°æ®æ˜¯æ•°ç»„ï¼ŒåŒ…å«è®¾å¤‡:', stats.length, 'å°');
                        if (stats.length > 0) {
                            console.log('ç¬¬ä¸€ä¸ªè®¾å¤‡ç¤ºä¾‹:', stats[0]);
                        }
                    } else {
                        console.log('æ•°æ®æ˜¯å•ä¸ªå¯¹è±¡ï¼Œè®¾å¤‡ID:', stats.deviceId);
                    }
                } else {
                    console.warn('âš ï¸ Gistè¿”å›çš„æ•°æ®ä¸ºç©ºæˆ–null');
                }
                
                // 3. è·å– GitHub Releases ä¸‹è½½é‡
                const githubStats = await fetchGitHubStats(token);
                
                // 4. ä¿å­˜æ•°æ®
                currentStats = stats;
                currentGithubStats = githubStats;
                
                // 5. æ˜¾ç¤ºæ•°æ®
                displayStats(stats, githubStats);
                
                // 6. å¦‚æœæœ‰ä¿å­˜çš„è®¾å¤‡IDï¼Œè‡ªåŠ¨åŠ è½½å½“å‰è®¾å¤‡ç»Ÿè®¡
                if (currentDeviceId) {
                    loadCurrentDeviceStatsFromData(stats);
                }
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        async function clearTestData() {
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();
            
            if (!token) {
                showError('è¯·è¾“å…¥ GitHub Token');
                return;
            }
            
            if (!gistId) {
                // å°è¯•æŸ¥æ‰¾Gist
                showLoading();
                try {
                    const foundGistId = await findGist(token);
                    if (!foundGistId) {
                        showError('æœªæ‰¾åˆ°ç»Ÿè®¡æ•°æ® Gist');
                        hideLoading();
                        return;
                    }
                    // ä½¿ç”¨æ‰¾åˆ°çš„Gist ID
                    document.getElementById('gistId').value = foundGistId;
                    await clearGistData(token, foundGistId);
                } catch (error) {
                    showError('æŸ¥æ‰¾Gistå¤±è´¥: ' + error.message);
                    hideLoading();
                }
            } else {
                await clearGistData(token, gistId);
            }
        }
        
        async function clearGistData(token, gistId) {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºGistä¸­çš„æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç»Ÿè®¡æ•°æ®ï¼Œåº”ç”¨ä¸‹æ¬¡ä¸Šä¼ æ—¶ä¼šé‡æ–°åˆ›å»ºã€‚')) {
                return;
            }
            
            showLoading();
            hideError();
            
            try {
                const emptyContent = JSON.stringify([], null, 2);
                
                const response = await fetch(`${GITHUB_API_BASE}/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: 'XMSLEEP App Usage Statistics',
                        files: {
                            'xmsleep_stats.json': {
                                content: emptyContent
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'æ¸…ç†å¤±è´¥');
                }
                
                alert('âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†ï¼Gistå·²æ¸…ç©ºã€‚è¯·ç¡®ä¿åº”ç”¨å·²é…ç½®GitHub Tokenï¼Œåº”ç”¨ä¸‹æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ä¸Šä¼ çœŸå®æ•°æ®ã€‚');
                console.log('Gistæ•°æ®å·²æ¸…ç©º');
                
                // æ¸…ç©ºæ˜¾ç¤º
                hideStats();
                
            } catch (error) {
                console.error('æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥:', error);
                showError('æ¸…ç†å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // åŠ è½½å½“å‰è®¾å¤‡ç»Ÿè®¡
        function loadCurrentDeviceStats() {
            const deviceId = document.getElementById('deviceIdInput').value.trim();
            if (!deviceId) {
                alert('è¯·è¾“å…¥è®¾å¤‡ ID');
                return;
            }
            
            // ä¿å­˜è®¾å¤‡ID
            localStorage.setItem('device_id', deviceId);
            currentDeviceId = deviceId;
            
            // å¦‚æœæœ‰å·²åŠ è½½çš„æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
            if (currentStats) {
                loadCurrentDeviceStatsFromData(currentStats);
            } else {
                alert('è¯·å…ˆåŠ è½½ç»Ÿè®¡æ•°æ®');
            }
        }
        
        // ä»å·²åŠ è½½çš„æ•°æ®ä¸­æ˜¾ç¤ºå½“å‰è®¾å¤‡ç»Ÿè®¡
        function loadCurrentDeviceStatsFromData(stats) {
            if (!currentDeviceId) return;
            
            const devices = Array.isArray(stats) ? stats : [stats];
            const currentDevice = devices.find(d => d.deviceId === currentDeviceId);
            
            const currentDeviceStatsDiv = document.getElementById('currentDeviceStats');
            const currentDeviceStatsContent = document.getElementById('currentDeviceStatsContent');
            const currentDeviceStatsGrid = document.getElementById('currentDeviceStatsGrid');
            
            if (!currentDevice) {
                currentDeviceStatsDiv.style.display = 'block';
                currentDeviceStatsContent.style.display = 'none';
                currentDeviceStatsGrid.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border-radius: 8px; color: #856404; text-align: center;">
                        <div style="font-size: 1.1em; margin-bottom: 10px;">âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡</div>
                        <div>è®¾å¤‡ ID "${currentDeviceId}" åœ¨ç»Ÿè®¡æ•°æ®ä¸­ä¸å­˜åœ¨ã€‚è¯·æ£€æŸ¥è®¾å¤‡ ID æ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç¡®ä¿è¯¥è®¾å¤‡å·²ä¸Šä¼ ç»Ÿè®¡æ•°æ®ã€‚</div>
                    </div>
                `;
                return;
            }
            
            // æ˜¾ç¤ºå½“å‰è®¾å¤‡ç»Ÿè®¡åŒºåŸŸ
            currentDeviceStatsDiv.style.display = 'block';
            currentDeviceStatsContent.style.display = 'block';
            
            // æ ¼å¼åŒ–ä½¿ç”¨æ—¶é•¿
            const totalHours = Math.floor(currentDevice.totalSessionTime / (1000 * 60 * 60));
            const totalMinutes = Math.floor((currentDevice.totalSessionTime % (1000 * 60 * 60)) / (1000 * 60));
            const formattedDuration = totalHours > 0 
                ? `${totalHours}.${Math.floor(totalMinutes / 6)}` 
                : (totalMinutes / 60).toFixed(1);
            
            // æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
            currentDeviceStatsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>å¯åŠ¨æ¬¡æ•°</h3>
                    <div class="value">${currentDevice.launchCount.toLocaleString()}</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <h3>ä½¿ç”¨æ—¶é•¿</h3>
                    <div class="value">${formattedDuration}</div>
                    <div class="unit">å°æ—¶</div>
                </div>
                <div class="stat-card">
                    <h3>æ´»è·ƒå¤©æ•°</h3>
                    <div class="value">${currentDevice.uniqueDays}</div>
                    <div class="unit">å¤©</div>
                </div>
                <div class="stat-card">
                    <h3>åº”ç”¨ç‰ˆæœ¬</h3>
                    <div class="value">${currentDevice.version}</div>
                    <div class="unit">(${currentDevice.versionCode})</div>
                </div>
            `;
            
            // æ·»åŠ è¯¦ç»†ä¿¡æ¯
            const detailInfo = document.createElement('div');
            detailInfo.style.cssText = 'margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;';
            detailInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; color: #666;">
                    <div>
                        <div style="font-weight: 500; color: #555; margin-bottom: 5px;">è®¾å¤‡ ID</div>
                        <div style="font-family: monospace; font-size: 0.9em;">${currentDevice.deviceId}</div>
                    </div>
                    <div>
                        <div style="font-weight: 500; color: #555; margin-bottom: 5px;">é¦–æ¬¡å¯åŠ¨</div>
                        <div>${formatDate(currentDevice.firstLaunch)}</div>
                    </div>
                    <div>
                        <div style="font-weight: 500; color: #555; margin-bottom: 5px;">æœ€åä½¿ç”¨</div>
                        <div>${formatDate(currentDevice.lastLaunch)}</div>
                    </div>
                    ${currentDevice.lastUpdate ? `
                    <div>
                        <div style="font-weight: 500; color: #555; margin-bottom: 5px;">æœ€åæ›´æ–°</div>
                        <div>${formatDate(currentDevice.lastUpdate)}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            currentDeviceStatsGrid.appendChild(detailInfo);
        }
        
        // ç¡®ä¿loadStatså‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.loadStats = loadStats;
        window.exportData = exportData;
        window.clearTestData = clearTestData;
        window.loadCurrentDeviceStats = loadCurrentDeviceStats;
        
        async function findGist(token) {
            const response = await fetch(`${GITHUB_API_BASE}/gists`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error('æ— æ³•è®¿é—® Gist API');
            }
            
            const gists = await response.json();
            const targetGist = gists.find(gist => 
                gist.description === 'XMSLEEP App Usage Statistics' &&
                gist.files['xmsleep_stats.json']
            );
            
            return targetGist?.id;
        }
        
        async function fetchGistData(token, gistId) {
            const response = await fetch(`${GITHUB_API_BASE}/gists/${gistId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error('æ— æ³•è¯»å– Gist æ•°æ®');
            }
            
            const gist = await response.json();
            const file = gist.files['xmsleep_stats.json'];
            
            if (!file || !file.content) {
                throw new Error('Gist ä¸­æ²¡æœ‰æ‰¾åˆ°ç»Ÿè®¡æ•°æ®');
            }
            
            return JSON.parse(file.content);
        }
        
        async function fetchGitHubStats(token) {
            const response = await fetch(`${GITHUB_API_BASE}/repos/${REPO_OWNER}/${REPO_NAME}/releases`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                console.warn('æ— æ³•è·å– GitHub Releases ç»Ÿè®¡');
                return null;
            }
            
            const releases = await response.json();
            let totalDownloads = 0;
            let latestDownloads = 0;
            
            if (releases.length > 0) {
                releases.forEach(release => {
                    const releaseDownloads = release.assets.reduce((sum, asset) => sum + (asset.download_count || 0), 0);
                    totalDownloads += releaseDownloads;
                    if (releaseDownloads > latestDownloads) {
                        latestDownloads = releaseDownloads;
                    }
                });
            }
            
            return { totalDownloads, latestDownloads, releases };
        }
        
        function displayStats(stats, githubStats) {
            const statsGrid = document.getElementById('statsGrid');
            const deviceList = document.getElementById('deviceList');
            const githubStatsDiv = document.getElementById('githubStats');
            const updateTimeDiv = document.getElementById('updateTime');
            
            // å¤„ç†ç»Ÿè®¡æ•°æ®ï¼ˆå¯èƒ½æ˜¯å•ä¸ªè®¾å¤‡æˆ–å¤šä¸ªè®¾å¤‡ï¼‰
            let devices = Array.isArray(stats) ? stats : [stats];
            console.log('å¤„ç†å‰çš„è®¾å¤‡æ•°æ®:', devices.length, 'æ¡');
            console.log('åŸå§‹æ•°æ®å†…å®¹:', stats);
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©º
            if (!stats || (Array.isArray(stats) && stats.length === 0) || (!Array.isArray(stats) && !stats.deviceId)) {
                // æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸï¼ˆå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿè¦æ˜¾ç¤ºï¼Œæ˜¾ç¤º0å€¼ï¼‰
                showStats();
                
                // æ˜¾ç¤º0å€¼ç»Ÿè®¡
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h3>æ€»å¯åŠ¨æ¬¡æ•°</h3>
                        <div class="value">0</div>
                        <div class="unit">æ¬¡</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ€»ä½¿ç”¨æ—¶é•¿</h3>
                        <div class="value">0.0</div>
                        <div class="unit">å°æ—¶</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ´»è·ƒå¤©æ•°</h3>
                        <div class="value">0</div>
                        <div class="unit">å¤©</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ´»è·ƒè®¾å¤‡æ•°</h3>
                        <div class="value">0</div>
                        <div class="unit">å°</div>
                    </div>
                `;
                
                hideLoading();
                console.log('Gistä¸­æ²¡æœ‰æ•°æ®');
                
                // æ˜¾ç¤ºGitHubä¸‹è½½ç»Ÿè®¡ï¼ˆå³ä½¿æ²¡æœ‰åº”ç”¨æ•°æ®ä¹Ÿè¦æ˜¾ç¤ºï¼‰
                if (githubStats) {
                    githubStatsDiv.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>æ€»ä¸‹è½½é‡</h3>
                                <div class="value">${githubStats.totalDownloads.toLocaleString()}</div>
                                <div class="unit">æ¬¡</div>
                            </div>
                            <div class="stat-card">
                                <h3>æœ€æ–°ç‰ˆæœ¬ä¸‹è½½é‡</h3>
                                <div class="value">${githubStats.latestDownloads.toLocaleString()}</div>
                                <div class="unit">æ¬¡</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; color: #004085; font-size: 0.9em; border-left: 4px solid #0066cc;">
                            <strong>â„¹ï¸ è¯´æ˜ï¼š</strong>GitHubä¸‹è½½é‡æ˜¯ä»GitHub Releases APIè·å–çš„çœŸå®æ•°æ®ï¼Œè¡¨ç¤ºä»GitHubä¸‹è½½APKçš„æ¬¡æ•°ã€‚
                            è¿™ä¸ä¸Šæ–¹çš„åº”ç”¨ä½¿ç”¨ç»Ÿè®¡ï¼ˆä»Gistè·å–ï¼‰æ˜¯<strong>ä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®æº</strong>ã€‚
                        </div>
                    `;
                }
                
                return;
            }
            
            // è¿‡æ»¤æµ‹è¯•æ•°æ®ï¼šè¯†åˆ«å¹¶ç§»é™¤æ˜æ˜¾å¼‚å¸¸çš„æµ‹è¯•æ•°æ®
            const originalCount = devices.length;
            const currentYear = new Date().getFullYear();
            devices = devices.filter(device => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æµ‹è¯•æ•°æ®
                const isTestData = 
                    // è®¾å¤‡IDåŒ…å«testã€mockã€dummyç­‰å…³é”®è¯
                    (device.deviceId && (
                        device.deviceId.toLowerCase().includes('test') ||
                        device.deviceId.toLowerCase().includes('mock') ||
                        device.deviceId.toLowerCase().includes('dummy') ||
                        device.deviceId.toLowerCase().includes('sample')
                    )) ||
                    // æ•°æ®å€¼å¼‚å¸¸ï¼ˆå¯èƒ½æ˜¯æµ‹è¯•æ•°æ®ï¼‰
                    (device.launchCount > 100000) ||  // å¯åŠ¨æ¬¡æ•°å¼‚å¸¸å¤§ï¼ˆè¶…è¿‡10ä¸‡æ¬¡ï¼‰
                    (device.totalSessionTime > 365 * 24 * 60 * 60 * 1000 * 2) ||  // ä½¿ç”¨æ—¶é•¿è¶…è¿‡2å¹´ï¼ˆå¼‚å¸¸ï¼‰
                    (device.uniqueDays > 365 * 3) ||  // æ´»è·ƒå¤©æ•°è¶…è¿‡3å¹´ï¼ˆéå¸¸å¯ç–‘ï¼Œçº¦1095å¤©ï¼‰
                    // æ•°æ®æ˜æ˜¾ä¸åˆç†ï¼šæ´»è·ƒå¤©æ•°å¤šä½†å¯åŠ¨æ¬¡æ•°å¾ˆå°‘ï¼Œæˆ–åä¹‹
                    (device.uniqueDays > 500 && device.launchCount < 100) ||  // æ´»è·ƒå¤©æ•°å¤šä½†å¯åŠ¨æ¬¡æ•°å°‘
                    (device.launchCount > 50000 && device.uniqueDays < 5) ||  // å¯åŠ¨æ¬¡æ•°å¤šä½†æ´»è·ƒå¤©æ•°å°‘
                    // è®¾å¤‡IDæ˜¯å¸¸è§çš„æµ‹è¯•å€¼
                    (device.deviceId === '999' || device.deviceId === '123' || device.deviceId === '0' || 
                     device.deviceId === '-999' || device.deviceId === '-123') ||
                    // é¦–æ¬¡å¯åŠ¨æ—¶é—´å¼‚å¸¸ï¼ˆæœªæ¥æ—¶é—´æˆ–1970å¹´ä¹‹å‰ï¼‰
                    (device.firstLaunch && (device.firstLaunch > Date.now() || device.firstLaunch < 0)) ||
                    // æœ€åå¯åŠ¨æ—¶é—´å¼‚å¸¸
                    (device.lastLaunch && (device.lastLaunch > Date.now() || device.lastLaunch < device.firstLaunch)) ||
                    // æ•°æ®æ—¶é—´æˆ³è¿‡æ—¶ä¸”æ•°æ®å¼‚å¸¸ï¼šæœ€åæ›´æ–°æ—¶é—´æ˜¯2024å¹´æˆ–æ›´æ—©ï¼Œä¸”æ•°æ®å€¼å¼‚å¸¸ï¼ˆå¯èƒ½æ˜¯æ—§çš„æµ‹è¯•æ•°æ®ï¼‰
                    ((device.lastUpdate && new Date(device.lastUpdate).getFullYear() < currentYear) && 
                     (device.uniqueDays > 100 || device.launchCount > 10000)) ||
                    ((device.lastLaunch && new Date(device.lastLaunch).getFullYear() < currentYear) && 
                     (device.uniqueDays > 100 || device.launchCount > 10000));
                
                return !isTestData;
            });
            
            // å¦‚æœè¿‡æ»¤æ‰äº†æ•°æ®ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (devices.length < originalCount) {
                const removedCount = originalCount - devices.length;
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = 'margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; color: #856404; font-size: 0.9em;';
                warningDiv.innerHTML = `âš ï¸ å·²è‡ªåŠ¨è¿‡æ»¤ ${removedCount} æ¡æµ‹è¯•æ•°æ®ï¼ˆåŸå§‹æ•°æ®: ${originalCount} æ¡ï¼Œè¿‡æ»¤å: ${devices.length} æ¡ï¼‰ã€‚å¦‚æœä»æœ‰å¼‚å¸¸æ•°æ®ï¼Œè¯·æ£€æŸ¥ Gist å†…å®¹æˆ–ä½¿ç”¨ clear_stats.py æ¸…ç†æ•°æ®ã€‚`;
                updateTimeDiv.parentNode?.insertBefore(warningDiv, updateTimeDiv.nextSibling);
                console.log(`è¿‡æ»¤æµ‹è¯•æ•°æ®: åŸå§‹ ${originalCount} æ¡ï¼Œè¿‡æ»¤å ${devices.length} æ¡ï¼Œç§»é™¤äº† ${removedCount} æ¡`);
            }
            
            allDevices = devices;
            console.log('è¿‡æ»¤åçš„è®¾å¤‡æ•°æ®:', devices.length, 'æ¡');
            console.log('è¿‡æ»¤åçš„è®¾å¤‡è¯¦æƒ…:', devices.map(d => ({
                deviceId: d.deviceId,
                launchCount: d.launchCount,
                uniqueDays: d.uniqueDays,
                totalSessionTime: d.totalSessionTime
            })));
            
            // å¦‚æœè¿‡æ»¤åæ²¡æœ‰æ•°æ®äº†ï¼Œæ˜¾ç¤ºæç¤ºï¼Œä½†ä»ç„¶æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ
            if (devices.length === 0) {
                // æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸï¼ˆæ˜¾ç¤º0å€¼ï¼‰
                showStats();
                
                // æ˜¾ç¤º0å€¼ç»Ÿè®¡
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h3>æ€»å¯åŠ¨æ¬¡æ•°</h3>
                        <div class="value">0</div>
                        <div class="unit">æ¬¡</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ€»ä½¿ç”¨æ—¶é•¿</h3>
                        <div class="value">0.0</div>
                        <div class="unit">å°æ—¶</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ´»è·ƒå¤©æ•°</h3>
                        <div class="value">0</div>
                        <div class="unit">å¤©</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ´»è·ƒè®¾å¤‡æ•°</h3>
                        <div class="value">0</div>
                        <div class="unit">å°</div>
                    </div>
                `;
                
                const noDataDiv = document.createElement('div');
                noDataDiv.style.cssText = 'margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 4px; color: #856404; text-align: center;';
                noDataDiv.innerHTML = `
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">ğŸ“Š æ²¡æœ‰çœŸå®æ•°æ®</div>
                    <div style="margin-bottom: 15px;">æ‰€æœ‰æ•°æ®å·²è¢«è¯†åˆ«ä¸ºæµ‹è¯•æ•°æ®å¹¶è¿‡æ»¤ã€‚Gistä¸­å¯èƒ½åªåŒ…å«æµ‹è¯•æ•°æ®ã€‚</div>
                    <div style="margin-bottom: 15px;">
                        <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                        1. ç‚¹å‡»"æ¸…ç†æµ‹è¯•æ•°æ®"æŒ‰é’®æ¸…ç©ºGist<br>
                        2. ç¡®ä¿åº”ç”¨å·²é…ç½®GitHub Tokenï¼ˆåœ¨gradle.propertiesä¸­ï¼‰<br>
                        3. é‡æ–°å¯åŠ¨åº”ç”¨ï¼Œåº”ç”¨ä¼šè‡ªåŠ¨ä¸Šä¼ çœŸå®æ•°æ®
                    </div>
                    <button onclick="clearTestData()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                        æ¸…ç†æµ‹è¯•æ•°æ®
                    </button>
                `;
                statsGrid.parentNode?.insertBefore(noDataDiv, statsGrid.nextSibling);
                hideLoading();
                
                // æ˜¾ç¤ºGitHubä¸‹è½½ç»Ÿè®¡
                if (githubStats) {
                    githubStatsDiv.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>æ€»ä¸‹è½½é‡</h3>
                                <div class="value">${githubStats.totalDownloads.toLocaleString()}</div>
                                <div class="unit">æ¬¡</div>
                            </div>
                            <div class="stat-card">
                                <h3>æœ€æ–°ç‰ˆæœ¬ä¸‹è½½é‡</h3>
                                <div class="value">${githubStats.latestDownloads.toLocaleString()}</div>
                                <div class="unit">æ¬¡</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; color: #004085; font-size: 0.9em; border-left: 4px solid #0066cc;">
                            <strong>â„¹ï¸ è¯´æ˜ï¼š</strong>GitHubä¸‹è½½é‡æ˜¯ä»GitHub Releases APIè·å–çš„çœŸå®æ•°æ®ï¼Œè¡¨ç¤ºä»GitHubä¸‹è½½APKçš„æ¬¡æ•°ã€‚
                            è¿™ä¸ä¸Šæ–¹çš„åº”ç”¨ä½¿ç”¨ç»Ÿè®¡ï¼ˆä»Gistè·å–ï¼‰æ˜¯<strong>ä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®æº</strong>ã€‚
                        </div>
                    `;
                }
                
                return;
            }
            
            // æ˜¾ç¤ºæ›´æ–°æ—¶é—´
            const latestUpdate = Math.max(...devices.map(d => d.lastUpdate || 0));
            if (latestUpdate > 0) {
                const updateDate = new Date(latestUpdate);
                const now = new Date();
                const daysSinceUpdate = Math.floor((now - updateDate) / (24 * 60 * 60 * 1000));
                
                // æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æ—¶ï¼ˆè¶…è¿‡180å¤©æœªæ›´æ–°ï¼Œæˆ–å¹´ä»½æ˜¯2024å¹´åŠä»¥å‰ï¼‰
                const isOutdated = daysSinceUpdate > 180 || updateDate.getFullYear() < 2025;
                
                updateTimeDiv.textContent = `æœ€åæ›´æ–°: ${formatDate(latestUpdate)}`;
                
                if (isOutdated) {
                    const outdatedWarning = document.createElement('div');
                    outdatedWarning.style.cssText = 'margin-top: 10px; padding: 15px; background: #f8d7da; border-radius: 4px; color: #721c24; font-size: 1em; border-left: 4px solid #dc3545;';
                    outdatedWarning.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 10px; font-size: 1.1em;">âš ï¸ è­¦å‘Š: æ•°æ®å·²è¿‡æ—¶ï¼ˆ${daysSinceUpdate}å¤©å‰æ›´æ–°ï¼Œå¹´ä»½: ${updateDate.getFullYear()}ï¼‰</div>
                        <div style="margin-bottom: 10px;">è¿™äº›å¯èƒ½æ˜¯æ—§çš„æµ‹è¯•æ•°æ®ã€‚å½“å‰æ˜¾ç¤ºçš„æ•°æ®<strong>ä¸æ˜¯çœŸå®æ•°æ®</strong>ï¼</div>
                        <div style="margin-top: 10px;">
                            <button onclick="clearTestData()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                ç«‹å³æ¸…ç†æµ‹è¯•æ•°æ®
                            </button>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            æ¸…ç†åï¼Œè¯·ç¡®ä¿åº”ç”¨å·²é…ç½®GitHub Tokenï¼Œåº”ç”¨ä¸‹æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ä¸Šä¼ çœŸå®æ•°æ®ã€‚
                        </div>
                    `;
                    updateTimeDiv.parentNode?.insertBefore(outdatedWarning, updateTimeDiv.nextSibling);
                    console.warn(`æ•°æ®è¿‡æ—¶è­¦å‘Š: æœ€åæ›´æ–°äº ${formatDate(latestUpdate)}, è·ä»Š ${daysSinceUpdate} å¤©`);
                }
            }
            
            // æ˜¾ç¤ºæ•°æ®æ¸…ç†æç¤ºï¼ˆå¦‚æœæœ‰ä¸æ´»è·ƒè®¾å¤‡ï¼‰
            const now = Date.now();
            const inactiveThreshold = 90 * 24 * 60 * 60 * 1000; // 90å¤©
            const inactiveDevices = devices.filter(d => {
                const lastLaunch = d.lastLaunch || d.lastUpdate || 0;
                return (now - lastLaunch) >= inactiveThreshold;
            });
            
            if (inactiveDevices.length > 0) {
                const cleanupInfo = document.createElement('div');
                cleanupInfo.style.cssText = 'margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; color: #856404; font-size: 0.9em;';
                cleanupInfo.innerHTML = `ğŸ’¡ æç¤º: æ£€æµ‹åˆ° ${inactiveDevices.length} å°è®¾å¤‡è¶…è¿‡90å¤©æœªä½¿ç”¨ï¼Œå°†åœ¨ä¸‹æ¬¡ä¸Šä¼ æ—¶è‡ªåŠ¨æ¸…ç†`;
                updateTimeDiv.parentNode?.insertBefore(cleanupInfo, updateTimeDiv.nextSibling);
            }
            
            // æ±‡æ€»ç»Ÿè®¡
            const totalLaunches = devices.reduce((sum, d) => sum + (d.launchCount || 0), 0);
            const totalSessionTime = devices.reduce((sum, d) => sum + (d.totalSessionTime || 0), 0);
            // æ´»è·ƒå¤©æ•°ï¼šè®¡ç®—æ‰€æœ‰è®¾å¤‡è¦†ç›–çš„æ€»å¤©æ•°èŒƒå›´ï¼ˆä»æœ€æ—©é¦–æ¬¡å¯åŠ¨åˆ°æœ€æ™šæœ€åå¯åŠ¨ï¼‰
            let totalUniqueDays = 0;
            if (devices.length > 0) {
                const earliestFirstLaunch = Math.min(...devices.map(d => d.firstLaunch || Date.now()));
                const latestLastLaunch = Math.max(...devices.map(d => d.lastLaunch || d.lastUpdate || Date.now()));
                // è®¡ç®—å¤©æ•°å·®
                const daysDiff = Math.ceil((latestLastLaunch - earliestFirstLaunch) / (24 * 60 * 60 * 1000));
                totalUniqueDays = Math.max(0, daysDiff);
            }
            const uniqueDevices = new Set(devices.map(d => d.deviceId)).size;
            
            // æ˜¾ç¤ºæ±‡æ€»ç»Ÿè®¡å¡ç‰‡
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>æ€»å¯åŠ¨æ¬¡æ•°</h3>
                    <div class="value">${totalLaunches.toLocaleString()}</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <h3>æ€»ä½¿ç”¨æ—¶é•¿</h3>
                    <div class="value">${formatDuration(totalSessionTime)}</div>
                    <div class="unit">å°æ—¶</div>
                </div>
                <div class="stat-card">
                    <h3>æ´»è·ƒå¤©æ•°</h3>
                    <div class="value">${totalUniqueDays}</div>
                    <div class="unit">å¤©</div>
                </div>
                <div class="stat-card">
                    <h3>æ´»è·ƒè®¾å¤‡æ•°</h3>
                    <div class="value">${uniqueDevices}</div>
                    <div class="unit">å°</div>
                </div>
            `;
            
            // æ³¨æ„ï¼šå¦‚æœæ•°æ®ä¸º0ï¼Œè¯´æ˜å·²ç»åœ¨å‰é¢å¤„ç†è¿‡äº†ï¼ˆGistä¸ºç©ºæˆ–å…¨éƒ¨è¢«è¿‡æ»¤ï¼‰ï¼Œè¿™é‡Œä¸å†é‡å¤æ·»åŠ è¯´æ˜
            
            // æ˜¾ç¤º GitHub ä¸‹è½½ç»Ÿè®¡
            if (githubStats) {
                githubStatsDiv.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>æ€»ä¸‹è½½é‡</h3>
                            <div class="value">${githubStats.totalDownloads.toLocaleString()}</div>
                            <div class="unit">æ¬¡</div>
                        </div>
                        <div class="stat-card">
                            <h3>æœ€æ–°ç‰ˆæœ¬ä¸‹è½½é‡</h3>
                            <div class="value">${githubStats.latestDownloads.toLocaleString()}</div>
                            <div class="unit">æ¬¡</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; color: #004085; font-size: 0.9em; border-left: 4px solid #0066cc;">
                        <strong>â„¹ï¸ è¯´æ˜ï¼š</strong>GitHubä¸‹è½½é‡æ˜¯ä»GitHub Releases APIè·å–çš„çœŸå®æ•°æ®ï¼Œè¡¨ç¤ºä»GitHubä¸‹è½½APKçš„æ¬¡æ•°ã€‚
                        è¿™ä¸ä¸Šæ–¹çš„åº”ç”¨ä½¿ç”¨ç»Ÿè®¡ï¼ˆä»Gistè·å–ï¼‰æ˜¯<strong>ä¸¤ä¸ªç‹¬ç«‹çš„æ•°æ®æº</strong>ã€‚
                        å¦‚æœåº”ç”¨ä½¿ç”¨ç»Ÿè®¡æ˜¾ç¤ºä¸º0ï¼Œè¯´æ˜Gistä¸­æ²¡æœ‰æ•°æ®ï¼Œéœ€è¦åº”ç”¨ä¸Šä¼ ä½¿ç”¨ç»Ÿè®¡æ•°æ®ã€‚
                    </div>
                `;
            }
            
            // åˆå§‹æ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡
            filteredDevices = [...devices];
            
            // æ‡’åŠ è½½ä¼˜åŒ–ï¼šåªç»˜åˆ¶å‰50ä¸ªè®¾å¤‡çš„å›¾è¡¨ï¼ˆé¿å…æ€§èƒ½é—®é¢˜ï¼‰
            const chartDevices = devices.length > 50 
                ? devices.slice(0, 50)  // å›¾è¡¨æœ€å¤šæ˜¾ç¤º50ä¸ªè®¾å¤‡
                : devices;
            drawCharts(chartDevices);
            
            // æ˜¾ç¤ºç»Ÿè®¡åŒºåŸŸ
            showStats();
            
            // æ˜¾ç¤ºå½“å‰è®¾å¤‡ç»Ÿè®¡åŒºåŸŸï¼ˆå¦‚æœå·²è®¾ç½®è®¾å¤‡IDï¼‰
            if (currentDeviceId) {
                document.getElementById('currentDeviceStats').style.display = 'block';
                loadCurrentDeviceStatsFromData(stats);
            } else {
                document.getElementById('currentDeviceStats').style.display = 'block';
            }
            
            // åº”ç”¨è¿‡æ»¤å’Œæ’åºï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²æ›´æ–°ï¼‰
            setTimeout(() => {
                filterAndSortDevices();
            }, 100);
        }
        
        function filterAndSortDevices() {
            const searchInput = document.getElementById('searchInput');
            const sortSelect = document.getElementById('sortSelect');
            const deviceList = document.getElementById('deviceList');
            const deviceCount = document.getElementById('deviceCount');
            
            // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼ˆæ•°æ®è¿˜æ²¡åŠ è½½ï¼‰ï¼Œç›´æ¥è¿”å›
            if (!searchInput || !sortSelect || !deviceList || allDevices.length === 0) {
                return;
            }
            
            // æœç´¢è¿‡æ»¤
            const searchTerm = searchInput.value.toLowerCase().trim();
            filteredDevices = allDevices.filter(device => {
                const deviceId = device.deviceId.toLowerCase();
                return deviceId.includes(searchTerm);
            });
            
            // æ’åº
            const [sortField, sortOrder] = sortSelect.value.split('-');
            filteredDevices.sort((a, b) => {
                let aVal = a[sortField] || 0;
                let bVal = b[sortField] || 0;
                
                if (sortField === 'lastLaunch') {
                    aVal = a.lastLaunch || 0;
                    bVal = b.lastLaunch || 0;
                }
                
                if (sortOrder === 'desc') {
                    return bVal - aVal;
                } else {
                    return aVal - bVal;
                }
            });
            
            // æ›´æ–°è®¾å¤‡æ•°é‡
            deviceCount.textContent = `(${filteredDevices.length}/${allDevices.length})`;
            
            // æ›´æ–°å›¾è¡¨ï¼ˆä½¿ç”¨è¿‡æ»¤åçš„è®¾å¤‡ï¼Œä½†é™åˆ¶æ•°é‡é¿å…æ€§èƒ½é—®é¢˜ï¼‰
            const chartDevices = filteredDevices.length > 50 
                ? filteredDevices.slice(0, 50)  // å›¾è¡¨æœ€å¤šæ˜¾ç¤º50ä¸ªè®¾å¤‡
                : filteredDevices;
            drawCharts(chartDevices);
            
            // é‡ç½®åˆ†é¡µå’Œæ‡’åŠ è½½çŠ¶æ€
            currentPage = 1;
            selectedDeviceIndex = -1;
            renderedPages.clear(); // æ¸…ç©ºå·²æ¸²æŸ“é¡µé¢è®°å½•
            
            // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨ï¼ˆæ ¹æ®æ•°é‡é€‰æ‹©å±•ç¤ºæ–¹å¼ï¼‰
            if (filteredDevices.length <= 3) {
                // è®¾å¤‡å°‘æ—¶ç›´æ¥æ˜¾ç¤º
                deviceList.innerHTML = filteredDevices.map(device => `
                    <div class="device-item">
                        <h4>è®¾å¤‡ ${device.deviceId.substring(0, 8)}...</h4>
                        <div class="info">
                            <div class="info-item">
                                <span class="info-label">ç‰ˆæœ¬</span>
                                <span>${device.version} (${device.versionCode})</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">å¯åŠ¨æ¬¡æ•°</span>
                                <span>${device.launchCount}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ä½¿ç”¨æ—¶é•¿</span>
                                <span>${formatDuration(device.totalSessionTime)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æ´»è·ƒå¤©æ•°</span>
                                <span>${device.uniqueDays} å¤©</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">é¦–æ¬¡å¯åŠ¨</span>
                                <span>${formatDate(device.firstLaunch)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æœ€åä½¿ç”¨</span>
                                <span>${formatDate(device.lastLaunch)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else if (filteredDevices.length <= 20) {
                // è®¾å¤‡ä¸­ç­‰æ•°é‡æ—¶ä½¿ç”¨æ ‡ç­¾é¡µ
                const tabsContainer = document.createElement('div');
                tabsContainer.className = 'tabs-container';
                
                // åˆ›å»ºæ ‡ç­¾é¡µå¤´éƒ¨
                const tabsHeader = document.createElement('div');
                tabsHeader.className = 'tabs-header';
                
                // åˆ›å»ºæ ‡ç­¾é¡µå†…å®¹
                const tabsContent = document.createElement('div');
                
                filteredDevices.forEach((device, index) => {
                    // åˆ›å»ºæ ‡ç­¾æŒ‰é’®
                    const tabButton = document.createElement('button');
                    tabButton.className = `tab-button ${index === 0 ? 'active' : ''}`;
                    tabButton.textContent = `è®¾å¤‡ ${device.deviceId.substring(0, 8)}...`;
                    tabButton.onclick = () => switchTab(index);
                    tabsHeader.appendChild(tabButton);
                    
                    // åˆ›å»ºæ ‡ç­¾å†…å®¹
                    const tabContent = document.createElement('div');
                    tabContent.className = `tab-content ${index === 0 ? 'active' : ''}`;
                    tabContent.innerHTML = `
                        <div class="device-item">
                            <h4>è®¾å¤‡ ${device.deviceId.substring(0, 8)}...</h4>
                            <div class="info">
                                <div class="info-item">
                                    <span class="info-label">ç‰ˆæœ¬</span>
                                    <span>${device.version} (${device.versionCode})</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">å¯åŠ¨æ¬¡æ•°</span>
                                    <span>${device.launchCount}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ä½¿ç”¨æ—¶é•¿</span>
                                    <span>${formatDuration(device.totalSessionTime)}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æ´»è·ƒå¤©æ•°</span>
                                    <span>${device.uniqueDays} å¤©</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">é¦–æ¬¡å¯åŠ¨</span>
                                    <span>${formatDate(device.firstLaunch)}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">æœ€åä½¿ç”¨</span>
                                    <span>${formatDate(device.lastLaunch)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    tabsContent.appendChild(tabContent);
                });
                
                tabsContainer.appendChild(tabsHeader);
                tabsContainer.appendChild(tabsContent);
                deviceList.innerHTML = '';
                deviceList.appendChild(tabsContainer);
            } else {
                // è®¾å¤‡å¾ˆå¤šæ—¶ä½¿ç”¨åˆ†é¡µåˆ—è¡¨
                renderPaginatedDevices(filteredDevices);
            }
        }
        
        function drawCharts(devices) {
            // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
            if (typeof Chart === 'undefined') {
                console.warn('Chart.jsæœªåŠ è½½ï¼Œè·³è¿‡å›¾è¡¨ç»˜åˆ¶');
                return;
            }
            
            // é”€æ¯æ—§å›¾è¡¨
            if (durationChart) {
                try {
                    durationChart.destroy();
                } catch (e) {
                    console.warn('é”€æ¯durationChartå¤±è´¥:', e);
                }
            }
            if (launchChart) {
                try {
                    launchChart.destroy();
                } catch (e) {
                    console.warn('é”€æ¯launchChartå¤±è´¥:', e);
                }
            }
            
            if (!devices || devices.length === 0) {
                console.warn('æ²¡æœ‰è®¾å¤‡æ•°æ®ï¼Œè·³è¿‡å›¾è¡¨ç»˜åˆ¶');
                return;
            }
            
            const labels = devices.map(d => `è®¾å¤‡ ${d.deviceId.substring(0, 8)}...`);
            const durations = devices.map(d => Math.round(d.totalSessionTime / (1000 * 60 * 60) * 10) / 10);
            const launches = devices.map(d => d.launchCount);
            
            // ä½¿ç”¨æ—¶é•¿å›¾è¡¨
            const durationCtx = document.getElementById('durationChart');
            if (durationCtx) {
                try {
                    durationChart = new Chart(durationCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ä½¿ç”¨æ—¶é•¿ï¼ˆå°æ—¶ï¼‰',
                            data: durations,
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                } catch (e) {
                    console.error('åˆ›å»ºdurationChartå¤±è´¥:', e);
                }
            }
            
            // å¯åŠ¨æ¬¡æ•°å›¾è¡¨
            const launchCtx = document.getElementById('launchChart');
            if (launchCtx) {
                try {
                    launchChart = new Chart(launchCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å¯åŠ¨æ¬¡æ•°',
                            data: launches,
                            backgroundColor: 'rgba(118, 75, 162, 0.6)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                } catch (e) {
                    console.error('åˆ›å»ºlaunchChartå¤±è´¥:', e);
                }
            }
        }
        
        function exportData(format) {
            if (!currentStats) {
                alert('è¯·å…ˆåŠ è½½æ•°æ®');
                return;
            }
            
            const devices = Array.isArray(currentStats) ? currentStats : [currentStats];
            
            if (format === 'csv') {
                // å¯¼å‡ºCSV
                const headers = ['è®¾å¤‡ID', 'ç‰ˆæœ¬', 'ç‰ˆæœ¬ä»£ç ', 'å¯åŠ¨æ¬¡æ•°', 'ä½¿ç”¨æ—¶é•¿(å°æ—¶)', 'æ´»è·ƒå¤©æ•°', 'é¦–æ¬¡å¯åŠ¨', 'æœ€åä½¿ç”¨'];
                const rows = devices.map(d => [
                    d.deviceId,
                    d.version,
                    d.versionCode,
                    d.launchCount,
                    (d.totalSessionTime / (1000 * 60 * 60)).toFixed(2),
                    d.uniqueDays,
                    formatDate(d.firstLaunch),
                    formatDate(d.lastLaunch)
                ]);
                
                const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
                downloadFile(csv, 'xmsleep_stats.csv', 'text/csv');
            } else if (format === 'json') {
                // å¯¼å‡ºJSON
                const json = JSON.stringify(devices, null, 2);
                downloadFile(json, 'xmsleep_stats.json', 'application/json');
            }
        }
        
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function formatDuration(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            if (hours > 0) {
                return `${hours}.${Math.floor(minutes / 6)}`;
            }
            return (minutes / 60).toFixed(1);
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'æœªçŸ¥';
            return new Date(timestamp).toLocaleString('zh-CN');
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        function showStats() {
            document.getElementById('stats').style.display = 'block';
        }
        
        function hideStats() {
            document.getElementById('stats').style.display = 'none';
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢å‡½æ•°
        function switchTab(index) {
            const tabsContainer = document.querySelector('.tabs-container');
            if (!tabsContainer) return;
            
            const buttons = tabsContainer.querySelectorAll('.tab-button');
            const contents = tabsContainer.querySelectorAll('.tab-content');
            
            buttons.forEach((btn, i) => {
                if (i === index) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            contents.forEach((content, i) => {
                if (i === index) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }
        
        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1;
        const devicesPerPage = 20;
        let selectedDeviceIndex = -1;
        let allDevicesData = []; // å­˜å‚¨æ‰€æœ‰è®¾å¤‡æ•°æ®ï¼ˆæ‡’åŠ è½½ï¼‰
        let renderedPages = new Set(); // è®°å½•å·²æ¸²æŸ“çš„é¡µé¢
        
        // æ¸²æŸ“åˆ†é¡µè®¾å¤‡åˆ—è¡¨ï¼ˆæ‡’åŠ è½½ä¼˜åŒ–ï¼‰
        function renderPaginatedDevices(devices) {
            const deviceList = document.getElementById('deviceList');
            if (!deviceList) return;
            
            // ä¿å­˜æ‰€æœ‰è®¾å¤‡æ•°æ®ï¼ˆç”¨äºæ‡’åŠ è½½ï¼‰
            allDevicesData = devices;
            
            const totalPages = Math.ceil(devices.length / devicesPerPage);
            const startIndex = (currentPage - 1) * devicesPerPage;
            const endIndex = startIndex + devicesPerPage;
            const pageDevices = devices.slice(startIndex, endIndex);
            
            // æ ‡è®°å½“å‰é¡µå·²æ¸²æŸ“
            renderedPages.add(currentPage);
            
            // åˆ›å»ºå®¹å™¨
            const container = document.createElement('div');
            
            // è®¾å¤‡å¡ç‰‡ç½‘æ ¼
            const devicesGrid = document.createElement('div');
            devicesGrid.className = 'devices-grid';
            
            pageDevices.forEach((device, index) => {
                const globalIndex = startIndex + index;
                const card = document.createElement('div');
                card.className = `device-card ${selectedDeviceIndex === globalIndex ? 'selected' : ''}`;
                card.onclick = () => selectDevice(globalIndex, devices);
                card.innerHTML = `
                    <h5>è®¾å¤‡ ${device.deviceId.substring(0, 8)}...</h5>
                    <div class="quick-stats">
                        <div>å¯åŠ¨: ${device.launchCount}æ¬¡</div>
                        <div>æ—¶é•¿: ${formatDuration(device.totalSessionTime)}h</div>
                        <div>æ´»è·ƒ: ${device.uniqueDays}å¤©</div>
                    </div>
                `;
                devicesGrid.appendChild(card);
            });
            
            container.appendChild(devicesGrid);
            
            // åˆ†é¡µæ§ä»¶
            const pagination = document.createElement('div');
            pagination.className = 'pagination';
            
            const prevButton = document.createElement('button');
            prevButton.textContent = 'ä¸Šä¸€é¡µ';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    selectedDeviceIndex = -1;
                    // æ‡’åŠ è½½ï¼šåªæ¸²æŸ“å½“å‰é¡µ
                    renderPaginatedDevices(devices);
                }
            };
            
            const nextButton = document.createElement('button');
            nextButton.textContent = 'ä¸‹ä¸€é¡µ';
            nextButton.disabled = currentPage >= totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    selectedDeviceIndex = -1;
                    // æ‡’åŠ è½½ï¼šåªæ¸²æŸ“å½“å‰é¡µ
                    renderPaginatedDevices(devices);
                }
            };
            
            const pageInfo = document.createElement('span');
            pageInfo.className = 'pagination-info';
            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ (${devices.length} å°è®¾å¤‡)`;
            
            // é¡µç æŒ‰é’®ï¼ˆæœ€å¤šæ˜¾ç¤º5ä¸ªï¼‰
            const pageButtons = document.createElement('div');
            pageButtons.style.display = 'flex';
            pageButtons.style.gap = '5px';
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => {
                    currentPage = i;
                    selectedDeviceIndex = -1;
                    // æ‡’åŠ è½½ï¼šåªæ¸²æŸ“å½“å‰é¡µ
                    renderPaginatedDevices(devices);
                };
                pageButtons.appendChild(pageBtn);
            }
            
            pagination.appendChild(prevButton);
            pagination.appendChild(pageButtons);
            pagination.appendChild(nextButton);
            pagination.appendChild(pageInfo);
            
            container.appendChild(pagination);
            
            // æ‡’åŠ è½½ä¼˜åŒ–ï¼šé¢„åŠ è½½ç›¸é‚»é¡µé¢
            preloadAdjacentPages(currentPage, totalPages, devices);
            
            // è®¾å¤‡è¯¦æƒ…é¢æ¿
            if (selectedDeviceIndex >= 0 && selectedDeviceIndex < devices.length) {
                const selectedDevice = devices[selectedDeviceIndex];
                const detailPanel = document.createElement('div');
                detailPanel.className = 'device-detail-panel';
                detailPanel.innerHTML = `
                    <h3 style="color: #333; margin-bottom: 15px;">è®¾å¤‡è¯¦æƒ…: ${selectedDevice.deviceId.substring(0, 8)}...</h3>
                    <div class="info">
                        <div class="info-item">
                            <span class="info-label">ç‰ˆæœ¬</span>
                            <span>${selectedDevice.version} (${selectedDevice.versionCode})</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å¯åŠ¨æ¬¡æ•°</span>
                            <span>${selectedDevice.launchCount}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ä½¿ç”¨æ—¶é•¿</span>
                            <span>${formatDuration(selectedDevice.totalSessionTime)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ´»è·ƒå¤©æ•°</span>
                            <span>${selectedDevice.uniqueDays} å¤©</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">é¦–æ¬¡å¯åŠ¨</span>
                            <span>${formatDate(selectedDevice.firstLaunch)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æœ€åä½¿ç”¨</span>
                            <span>${formatDate(selectedDevice.lastLaunch)}</span>
                        </div>
                    </div>
                `;
                container.appendChild(detailPanel);
            }
            
            deviceList.innerHTML = '';
            deviceList.appendChild(container);
        }
        
        // é€‰æ‹©è®¾å¤‡ï¼ˆæ‡’åŠ è½½ä¼˜åŒ–ï¼‰
        function selectDevice(index, devices) {
            selectedDeviceIndex = index;
            // æ‡’åŠ è½½ï¼šåªé‡æ–°æ¸²æŸ“å½“å‰é¡µï¼ˆä¸é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®ï¼‰
            renderPaginatedDevices(devices);
            // æ»šåŠ¨åˆ°è¯¦æƒ…é¢æ¿
            setTimeout(() => {
                const detailPanel = document.querySelector('.device-detail-panel');
                if (detailPanel) {
                    detailPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, 100);
        }
        
        // æ‡’åŠ è½½ä¼˜åŒ–ï¼šé¢„åŠ è½½ç›¸é‚»é¡µé¢ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰
        function preloadAdjacentPages(currentPage, totalPages, devices) {
            // é¢„åŠ è½½ä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µï¼ˆå¦‚æœå­˜åœ¨ä¸”æœªæ¸²æŸ“ï¼‰
            const pagesToPreload = [];
            if (currentPage > 1 && !renderedPages.has(currentPage - 1)) {
                pagesToPreload.push(currentPage - 1);
            }
            if (currentPage < totalPages && !renderedPages.has(currentPage + 1)) {
                pagesToPreload.push(currentPage + 1);
            }
            
            // å»¶è¿Ÿé¢„åŠ è½½ï¼Œé¿å…é˜»å¡å½“å‰æ¸²æŸ“
            if (pagesToPreload.length > 0) {
                setTimeout(() => {
                    pagesToPreload.forEach(page => {
                        // åªé¢„åŠ è½½æ•°æ®åˆ°å†…å­˜ï¼Œä¸æ¸²æŸ“DOM
                        renderedPages.add(page);
                    });
                }, 500); // å»¶è¿Ÿ500msé¢„åŠ è½½
            }
        }
    </script>
</body>
</html>

